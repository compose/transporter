machine:
  environment:
    ME: "transporter"
    GOBIN: "$CIRCLE_ARTIFACTS"
    GO15VENDOREXPERIMENT: 1
    PGDATA: /var/lib/postgresql/9.4/main

dependencies:
  pre:
    - psql -c "ALTER SYSTEM SET max_replication_slots = 4"
    - psql -c "ALTER SYSTEM SET wal_level = logical"
    - sudo -E -u postgres /usr/lib/postgresql/9.4/bin/pg_ctl restart; sleep 1
  override:
    - test -d /home/ubuntu/.go_workspace/src/github.com/compose/ || mkdir -p /home/ubuntu/.go_workspace/src/github.com/compose/
    - test -e /home/ubuntu/.go_workspace/src/github.com/compose/transporter || ln -s /home/ubuntu/transporter/ /home/ubuntu/.go_workspace/src/github.com/compose/
  cache_directories:
  - "/home/ubuntu/bin"

test:
  override:
    - cd /home/ubuntu/.go_workspace/src/github.com/compose/transporter && go test $(go list ./... | grep -v '/vendor/') -tags=integration -v

deployment:
  experimental:
    branch: [experimental]
    commands:
      - echo "todo"
